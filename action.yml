name: 'Jit security-controls action'
description: 'Runs a Jit security-control on a target dir'
inputs:
  container_args:
    description: 'container additional args'
    required: false
    default: ""
  security_control:
    description: "Docker image tag path of security control to execute"
    required: true
  security_control_output_file:
    description: "path to the security control output"
    required: false
    default: ""
  fail_on_findings:
    description: "fail control when finding is found"
    required: false
    default: "true"
  runner_setup:
    description: RunnerSetup dictionary
    default: '{"checkout": true}'
  inline_environment:
    description: "inline environment variables to be passed to the container"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Link job ID to Execution
      shell: bash
      continue-on-error: true
      run: |
        echo "Linking job ID to Jit"
        CI_RUN_ID=${{ fromJSON(github.run_id) }}
        CI_JIT_EVENT_ID=${{ fromJSON(github.event.inputs.client_payload).context.jit_event.jit_event_id }}
        CI_EXECUTION_ID=${{ fromJSON(github.event.inputs.client_payload).execution_data.execution_id }}
        BODY=$( jq -n \
                  --arg vendor_job_id "$CI_RUN_ID" \
                  --arg jit_event_id "$CI_JIT_EVENT_ID" \
                  --arg execution_id "$CI_EXECUTION_ID" \
                  '{vendor_job_id: $vendor_job_id, jit_event_id: $jit_event_id, execution_id: $execution_id}' )
        curl \
          -X POST \
          -H "Authorization: Bearer ${{ fromJSON(github.event.inputs.client_payload).operational_data.callback_token }}" \
          -H "Content-Type: application/json" \
          -d "$BODY" \
          ${{ fromJSON(github.event.inputs.client_payload).operational_data.callback_urls.base_api }}/execution/start
